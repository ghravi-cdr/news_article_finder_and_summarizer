<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ“° NewsHub - Find Today's Breaking News</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://kit.fontawesome.com/YOUR_KIT_ID.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="container header-container">
      <div class="logo">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="NewsHub Logo" class="logo-img">
        <div class="logo-text">
          <span class="brand-name">NewsHub</span>
          <p class="subtitle">Discover today's stories</p>
        </div>
      </div>

      <button id="theme-toggle">
        {% if g.theme == 'dark' %}
          <i class="fas fa-sun"></i> Light Mode
        {% else %}
          <i class="fas fa-moon"></i> Dark Mode
        {% endif %}
      </button>

      <div class="info">
        <span class="date"><i class="fas fa-calendar-alt"></i> {{ current_date }}</span>
        <span class="coverage"><i class="fas fa-globe-americas"></i> Global Coverage</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <section class="hero-section">
      <h1 class="page-title">Find Today's Breaking News</h1>
      <p class="description">Search through thousands of articles from trusted sources worldwide. Stay informed with real-time updates and intelligent summarization.</p>
    </section>

    <!-- Search Bar -->
    <div class="centered-search">
      <form class="search-form" method="POST">
        <span class="search-icon">&#128269;</span>
        <input type="text" placeholder="Search for news topics..." name="keyword" value="{{ keyword }}" />
        <button class="search-btn" type="submit">Search</button>
      </form>

      <div class="popular-searches">
        <p>Popular Searches:</p>
        <a href="?q=Politics" class="tag">Politics</a>
        <a href="?q=Technology" class="tag">Technology</a>
        <a href="?q=Sports" class="tag">Sports</a>
        <a href="?q=Health" class="tag">Health</a>
        <a href="?q=Business" class="tag">Business</a>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="flash">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Results Section -->
    {% if keyword %}
      {% if news_results %}
        <h2 class="results-title">Results for "{{ keyword }}"</h2>
        <p class="results-count">Found {{ news_results|length }} articles â€¢ {{ current_date }}</p>

        <ul class="articles">
          {% for article in news_results %}
            <li class="article" id="article-{{ loop.index }}">
              <div class="article-image">
                {% if article.urlToImage %}
                  <img src="{{ article.urlToImage }}" alt="Article Image" loading="lazy">
                {% else %}
                  <img src="https://via.placeholder.com/180x120?text=No+Image" alt="No Image" loading="lazy">
                {% endif %}
              </div>
              <div class="article-details">
                <h3>{{ article.title }}</h3>
                <div class="article-meta">
                  <div class="source">
                    <i class="fas fa-newspaper"></i> {{ article.source.name }}
                  </div>
                  <div class="published-at">
                    <i class="fas fa-clock"></i> {{ article.publishedAt }}
                  </div>
                </div>
                {% if article.description %}
                  <p class="article-description">{{ article.description[:150] }}...</p>
                {% endif %}
              </div>
              
              <div class="article-actions">
                <button class="summarize-btn" onclick="summarizeArticle(this, '{{ article.url }}', '{{ article.title }}', '{{ keyword }}')">
                  <i class="fas fa-compress-alt"></i> Summarize
                </button>
                <a href="{{ article.url }}" target="_blank" class="read-full-btn">
                  <i class="fas fa-external-link-alt"></i> Read Full
                </a>
              </div>
              
              <div class="summary-container" id="summary-{{ loop.index }}" style="display: none;">
                <div class="summary-content"></div>
                <div class="summary-actions" style="display: none;">
                  <div class="share-section">
                    <h4><i class="fas fa-share-alt"></i> Share this article:</h4>
                    <div class="share-buttons">
                      <button class="share-btn twitter" onclick="shareToSocial('twitter', this)">
                        <i class="fab fa-twitter"></i> Twitter
                      </button>
                      <button class="share-btn facebook" onclick="shareToSocial('facebook', this)">
                        <i class="fab fa-facebook"></i> Facebook
                      </button>
                      <button class="share-btn linkedin" onclick="shareToSocial('linkedin', this)">
                        <i class="fab fa-linkedin"></i> LinkedIn
                      </button>
                      <button class="share-btn whatsapp" onclick="shareToSocial('whatsapp', this)">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                      </button>
                      <button class="share-btn email" onclick="shareToSocial('email', this)">
                        <i class="fas fa-envelope"></i> Email
                      </button>
                      <button class="share-btn copy-link" onclick="copyArticleLink(this)">
                        <i class="fas fa-link"></i> Copy Link
                      </button>
                    </div>
                  </div>
                  <div class="summary-stats">
                    <span class="stat" id="word-count-{{ loop.index }}"></span>
                    <span class="stat" id="summary-length-{{ loop.index }}"></span>
                  </div>
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>

      {% else %}
        <div class="no-results">
          <i class="fas fa-search"></i>
          <h3>No articles found for "{{ keyword }}"</h3>
          <p>Try searching with different keywords or check your spelling.</p>
        </div>
      {% endif %}
    {% endif %}
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 NewsHub. All rights reserved. | Enhanced with AI Summarization</p>
  </footer>

  <!-- JavaScript for Enhanced Functionality -->
  <script>
    let currentShareLinks = {};

    function summarizeArticle(button, url, title, keyword) {
      const articleIndex = button.closest('.article').id.split('-')[1];
      const summaryContainer = document.getElementById(`summary-${articleIndex}`);
      const summaryContent = summaryContainer.querySelector('.summary-content');
      const summaryActions = summaryContainer.querySelector('.summary-actions');
      
      // Show loading state
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Summarizing...';
      summaryContainer.style.display = 'block';
      summaryContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Analyzing article content...</div>';

      fetch("/summarize-ajax", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`
      })
      .then(response => response.json())
      .then(data => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-check"></i> Summarized';
        
        if (data.summary) {
          const highlightedSummary = highlight(data.summary, keyword);
          summaryContent.innerHTML = `
            <div class="summary-box">
              <h4><i class="fas fa-scroll"></i> AI Summary:</h4>
              <p class="summary-text">${highlightedSummary}</p>
            </div>
          `;
          
          // Store share links for this article
          currentShareLinks[articleIndex] = data.share_links;
          
          // Show share actions and stats
          summaryActions.style.display = 'block';
          
          // Update stats
          if (data.word_count) {
            document.getElementById(`word-count-${articleIndex}`).innerHTML = 
              `<i class="fas fa-file-text"></i> ${data.word_count} words`;
          }
          if (data.summary_length) {
            document.getElementById(`summary-length-${articleIndex}`).innerHTML = 
              `<i class="fas fa-compress"></i> ${data.summary_length} word summary`;
          }
          
        } else {
          summaryContent.innerHTML = `
            <div class="error-box">
              <i class="fas fa-exclamation-triangle"></i>
              <p>${data.error || 'Failed to summarize article'}</p>
            </div>
          `;
        }
      })
      .catch(err => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-compress-alt"></i> Summarize';
        summaryContent.innerHTML = `
          <div class="error-box">
            <i class="fas fa-wifi"></i>
            <p>Network error: ${err.message}</p>
          </div>
        `;
      });
    }

    function shareToSocial(platform, button) {
      const articleIndex = button.closest('.article').id.split('-')[1];
      const shareLinks = currentShareLinks[articleIndex];
      
      if (shareLinks && shareLinks[platform]) {
        window.open(shareLinks[platform], '_blank', 'width=600,height=400');
      }
    }

    function copyArticleLink(button) {
      const articleIndex = button.closest('.article').id.split('-')[1];
      const articleElement = button.closest('.article');
      const titleElement = articleElement.querySelector('h3');
      const title = titleElement ? titleElement.textContent : '';
      
      // Get the original article URL from the "Read Full" button
      const readFullBtn = articleElement.querySelector('.read-full-btn');
      const originalUrl = readFullBtn ? readFullBtn.href : '';
      
      if (originalUrl) {
        navigator.clipboard.writeText(originalUrl).then(() => {
          button.innerHTML = '<i class="fas fa-check"></i> Copied!';
          setTimeout(() => {
            button.innerHTML = '<i class="fas fa-link"></i> Copy Link';
          }, 2000);
        }).catch(() => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = originalUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          
          button.innerHTML = '<i class="fas fa-check"></i> Copied!';
          setTimeout(() => {
            button.innerHTML = '<i class="fas fa-link"></i> Copy Link';
          }, 2000);
        });
      }
    }

    function highlight(text, keyword) {
      if (!keyword || keyword.trim() === "") return text;
      const regex = new RegExp(`(${escapeRegex(keyword)})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Add smooth scrolling to search results
    document.addEventListener('DOMContentLoaded', function() {
      const searchForm = document.querySelector('.search-form');
      if (searchForm) {
        searchForm.addEventListener('submit', function() {
          setTimeout(() => {
            const resultsSection = document.querySelector('.results-title');
            if (resultsSection) {
              resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
          }, 100);
        });
      }
    });
  </script>

  <!-- JS Theme Toggle -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>